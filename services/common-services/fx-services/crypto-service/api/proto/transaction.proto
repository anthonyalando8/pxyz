// api/proto/transaction. proto
syntax = "proto3";

package crypto.v1;

option go_package = "shared/genproto/shared/accounting/cryptopb";

import "common.proto";
import "google/protobuf/timestamp.proto";

// TransactionService handles crypto transactions
service TransactionService {
    // Estimate network fee (for accounting module)
    rpc EstimateNetworkFee(EstimateNetworkFeeRequest) returns (EstimateNetworkFeeResponse);
    
    // Get withdrawal quote
    rpc GetWithdrawalQuote(GetWithdrawalQuoteRequest) returns (GetWithdrawalQuoteResponse);
    
    // Execute withdrawal from system wallet (called by accounting)
    rpc Withdraw(WithdrawRequest) returns (WithdrawResponse);
    
    // Sweep operations (internal)
    rpc SweepUserWallet(SweepUserWalletRequest) returns (SweepUserWalletResponse);

    // Sweep all user wallets for a specific asset and chain
    rpc SweepAllUsers(SweepAllUsersRequest) returns (SweepAllUsersResponse);
    
    // Transaction queries
    rpc GetTransaction(GetTransactionRequest) returns (GetTransactionResponse);

    // Get transactions for a user with filters and pagination
    rpc GetUserTransactions(GetUserTransactionsRequest) returns (GetUserTransactionsResponse);

    // Get transaction status by transaction ID
    rpc GetTransactionStatus(GetTransactionStatusRequest) returns (GetTransactionStatusResponse);

    // --- Admin operations for pending withdrawals ---
    rpc GetPendingWithdrawals(GetPendingWithdrawalsRequest) returns (GetPendingWithdrawalsResponse);
    // Approve pending withdrawals (called by admin interface)
    rpc ApproveWithdrawal(ApproveWithdrawalRequest) returns (ApproveWithdrawalResponse);
     // Reject pending withdrawals (called by admin interface)
    rpc RejectWithdrawal(RejectWithdrawalRequest) returns (RejectWithdrawalResponse);
    // Get details of a pending withdrawal (for admin review)
    rpc GetWithdrawalApproval(GetWithdrawalApprovalRequest) returns (GetWithdrawalApprovalResponse);
}

// ============================================================================
// NETWORK FEE ESTIMATION
// ============================================================================

message EstimateNetworkFeeRequest {
    Chain chain = 1;
    string asset = 2;
    string amount = 3;
    string to_address = 4;  // Optional, for more accurate estimation
}

message EstimateNetworkFeeResponse {
    Chain chain = 1;
    string asset = 2;
    string fee_amount = 3;       // In smallest unit
    string fee_currency = 4;     // Usually same as chain native token
    string fee_formatted = 5;    // Human-readable
    google.protobuf.Timestamp estimated_at = 6;
    int32 valid_for = 7;         // Seconds
    string explanation = 8;
}

// ============================================================================
// WITHDRAWAL
// ============================================================================

message WithdrawRequest {
    string accounting_tx_id  = 1;       // From accounting module (idempotency key)
    string user_id = 2;          // For tracking who requested
    Chain chain = 3;
    string asset = 4;
    string amount = 5;           // In smallest unit
    string to_address = 6;
    string memo = 7;             // Optional
}

message WithdrawResponse {
    Transaction transaction = 1;
    string message = 2;
}

// ============================================================================
// WITHDRAWAL QUOTE
// ============================================================================

message GetWithdrawalQuoteRequest {
    Chain chain = 1;
    string asset = 2;
    string amount = 3;
    string to_address = 4;
}

message GetWithdrawalQuoteResponse {
    string quote_id = 1;
    Chain chain = 2;
    string asset = 3;
    Money amount = 4;
    Money network_fee = 5;
    string network_fee_currency = 6;
    google.protobuf.Timestamp valid_until = 7;
    string explanation = 8;
}

// ============================================================================
// SWEEP OPERATIONS
// ============================================================================

message SweepUserWalletRequest {
    string user_id = 1;
    Chain chain = 2;
    string asset = 3;
}

message SweepUserWalletResponse {
    Transaction transaction = 1;
    string message = 2;
}

message SweepAllUsersRequest {
    Chain chain = 1;
    string asset = 2;
}

message SweepAllUsersResponse {
    repeated Transaction transactions = 1;
    int32 success_count = 2;
    int32 failed_count = 3;
    string message = 4;
}

// ============================================================================
// TRANSACTION QUERIES
// ============================================================================

message Transaction {
    int64 id = 1;
    string transaction_id = 2;
    string accounting_tx_id = 3;  // From accounting module
    string user_id = 4;
    TransactionType type = 5;
    Chain chain = 6;
    string asset = 7;
    
    string from_address = 8;
    string to_address = 9;
    bool is_internal = 10;
    
    Money amount = 11;
    Money network_fee = 12;
    
    string tx_hash = 13;
    int64 block_number = 14;
    int32 confirmations = 15;
    int32 required_confirmations = 16;
    
    TransactionStatus status = 17;
    string status_message = 18;
    
    google.protobuf.Timestamp initiated_at = 19;
    google.protobuf.Timestamp broadcasted_at = 20;
    google.protobuf.Timestamp confirmed_at = 21;
    google.protobuf.Timestamp created_at = 22;
}

message TransactionSummary {
    string transaction_id = 1;
    TransactionType type = 2;
    Chain chain = 3;
    string asset = 4;
    string amount = 5;
    string network_fee = 6;
    TransactionStatus status = 7;
    string tx_hash = 8;
    bool is_internal = 9;
    google.protobuf.Timestamp created_at = 10;
}

message GetTransactionRequest {
    string transaction_id = 1;
}

message GetTransactionResponse {
    Transaction transaction = 1;
}

message GetUserTransactionsRequest {
    string user_id = 1;
    Chain chain = 2;             // Optional filter
    string asset = 3;            // Optional filter
    TransactionType type = 4;    // Optional filter
    TransactionStatus status = 5; // Optional filter
    PaginationRequest pagination = 6;
}

message GetUserTransactionsResponse {
    repeated TransactionSummary transactions = 1;
    PaginationResponse pagination = 2;
}

message GetTransactionStatusRequest {
    string transaction_id = 1;
}

message GetTransactionStatusResponse {
    TransactionStatus status = 1;
    int32 confirmations = 2;
    int32 required_confirmations = 3;
    string tx_hash = 4;
    string status_message = 5;
    google.protobuf.Timestamp updated_at = 6;
}

message GetPendingWithdrawalsRequest {
    int32 limit = 1;
    int32 offset = 2;
    string chain = 3;     // Optional filter
    string asset = 4;     // Optional filter
    int32 min_risk_score = 5; // Filter by risk score
}

message GetPendingWithdrawalsResponse {
    repeated WithdrawalApprovalInfo approvals = 1;
    int32 total = 2;
}

message WithdrawalApprovalInfo {
    int64 id = 1;
    int64 transaction_id = 2;
    string user_id = 3;
    
    // Withdrawal details
    Money amount = 4;
    string asset = 5;
    Chain chain = 6;
    string to_address = 7;
    
    // Risk assessment
    int32 risk_score = 8;
    repeated RiskFactor risk_factors = 9;
    bool requires_approval = 10;
    
    // Status
    WithdrawalApprovalStatus status = 11;
    
    // Timestamps
    google.protobuf.Timestamp created_at = 12;
}

message RiskFactor {
    string factor = 1;
    string description = 2;
    int32 score = 3; // Contribution to total risk score
}

message ApproveWithdrawalRequest {
    int64 approval_id = 1;
    string approved_by = 2; // Admin user ID
    string notes = 3;       // Optional approval notes
}

message ApproveWithdrawalResponse {
    bool success = 1;
    string message = 2;
    Transaction transaction = 3; // Updated transaction
}

message RejectWithdrawalRequest {
    int64 approval_id = 1;
    string rejected_by = 2;      // Admin user ID
    string rejection_reason = 3; // Required
}

message RejectWithdrawalResponse {
    bool success = 1;
    string message = 2;
}

message GetWithdrawalApprovalRequest {
    int64 approval_id = 1;
}

message GetWithdrawalApprovalResponse {
    WithdrawalApprovalInfo approval = 1;
}

// ============================================================================
// ENUMS
// ============================================================================

enum WithdrawalApprovalStatus {
    WITHDRAWAL_APPROVAL_STATUS_UNSPECIFIED = 0;
    WITHDRAWAL_APPROVAL_STATUS_PENDING_REVIEW = 1;
    WITHDRAWAL_APPROVAL_STATUS_APPROVED = 2;
    WITHDRAWAL_APPROVAL_STATUS_REJECTED = 3;
    WITHDRAWAL_APPROVAL_STATUS_AUTO_APPROVED = 4;
}
