// api/proto/transaction.proto
syntax = "proto3";

package crypto. v1;

option go_package = "shared/genproto/shared/accounting/cryptopb";

import "common.proto";
import "google/protobuf/timestamp.proto";

// TransactionService handles crypto transactions
service TransactionService {
    // Withdraw to external address
    rpc Withdraw(WithdrawRequest) returns (WithdrawResponse);
    
    // Internal transfer between users
    rpc InternalTransfer(InternalTransferRequest) returns (InternalTransferResponse);
    
    // Get withdrawal fee quote
    rpc GetWithdrawalQuote(GetWithdrawalQuoteRequest) returns (GetWithdrawalQuoteResponse);
    
    // Get transaction by ID
    rpc GetTransaction(GetTransactionRequest) returns (GetTransactionResponse);
    
    // Get user transactions
    rpc GetUserTransactions(GetUserTransactionsRequest) returns (GetUserTransactionsResponse);
    
    // Get transaction status
    rpc GetTransactionStatus(GetTransactionStatusRequest) returns (GetTransactionStatusResponse);
    
    // Cancel pending transaction
    rpc CancelTransaction(CancelTransactionRequest) returns (CancelTransactionResponse);
}

// ============================================================================
// MESSAGES
// ============================================================================

// Transaction
message Transaction {
    int64 id = 1;
    string transaction_id = 2;  // UUID
    string user_id = 3;
    TransactionType type = 4;
    Chain chain = 5;
    string asset = 6;
    
    string from_address = 7;
    string to_address = 8;
    bool is_internal = 9;
    
    Money amount = 10;
    FeeBreakdown fees = 11;
    
    string tx_hash = 12;
    int64 block_number = 13;
    int32 confirmations = 14;
    int32 required_confirmations = 15;
    
    TransactionStatus status = 16;
    string status_message = 17;
    
    google.protobuf. Timestamp initiated_at = 18;
    google.protobuf.Timestamp confirmed_at = 19;
    google.protobuf.Timestamp created_at = 20;
}

// TransactionSummary (for lists)
message TransactionSummary {
    string transaction_id = 1;
    TransactionType type = 2;
    Chain chain = 3;
    string asset = 4;
    string amount = 5;
    string fee = 6;
    TransactionStatus status = 7;
    string tx_hash = 8;
    bool is_internal = 9;
    google.protobuf. Timestamp created_at = 10;
}

// Withdraw
message WithdrawRequest {
    string user_id = 1;
    Chain chain = 2;
    string asset = 3;
    string amount = 4;
    string to_address = 5;
    string memo = 6;  // Optional
    bool auto_confirm = 7;  // Skip confirmation step
}

message WithdrawResponse {
    Transaction transaction = 1;
    string message = 2;
}

// InternalTransfer
message InternalTransferRequest {
    string from_user_id = 1;
    string to_user_id = 2;
    Chain chain = 3;
    string asset = 4;
    string amount = 5;
    string memo = 6;
}

message InternalTransferResponse {
    Transaction transaction = 1;
    string message = 2;
}

// GetWithdrawalQuote
message GetWithdrawalQuoteRequest {
    string user_id = 1;
    Chain chain = 2;
    string asset = 3;
    string amount = 4;
    string to_address = 5;
}

message GetWithdrawalQuoteResponse {
    string quote_id = 1;
    Money amount = 2;
    FeeBreakdown fees = 3;
    Money total_cost = 4;  // amount + fees
    Money required_balance = 5;
    bool user_has_balance = 6;
    google.protobuf.Timestamp valid_until = 7;
    string explanation = 8;
}

// GetTransaction
message GetTransactionRequest {
    string transaction_id = 1;
    string user_id = 2;  // For authorization
}

message GetTransactionResponse {
    Transaction transaction = 1;
}

// GetUserTransactions
message GetUserTransactionsRequest {
    string user_id = 1;
    Chain chain = 2;  // Optional filter
    string asset = 3;  // Optional filter
    TransactionType type = 4;  // Optional filter
    TransactionStatus status = 5;  // Optional filter
    PaginationRequest pagination = 6;
}

message GetUserTransactionsResponse {
    repeated TransactionSummary transactions = 1;
    PaginationResponse pagination = 2;
}

// GetTransactionStatus
message GetTransactionStatusRequest {
    string transaction_id = 1;
    string user_id = 2;
}

message GetTransactionStatusResponse {
    TransactionStatus status = 1;
    int32 confirmations = 2;
    int32 required_confirmations = 3;
    string tx_hash = 4;
    string status_message = 5;
    google.protobuf.Timestamp updated_at = 6;
}

// CancelTransaction
message CancelTransactionRequest {
    string transaction_id = 1;
    string user_id = 2;
    string reason = 3;
}

message CancelTransactionResponse {
    bool success = 1;
    string message = 2;
}