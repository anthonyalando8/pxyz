<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Tester - Complete</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:   linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .left-panel, .right-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .connection-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius:  50%;
            background: #dc3545;
            display: inline-block;
        }

        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size:  14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline:  none;
            border-color:  #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size:  16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background:  #218838;
            transform:  translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin:  5px 0;
        }

        .btn-info {
            background: #17a2b8;
            color:  white;
            margin: 5px 0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .workflow {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .step {
            padding: 15px;
            margin:  10px 0;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }

        .step:hover {
            background: #f8f9fa;
        }

        .step.active {
            border-left-color: #667eea;
            background: #f0f3ff;
        }

        .step.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            background: #e9ecef;
            margin-right: 10px;
            font-weight: bold;
        }

        .step.active .step-number {
            background: #667eea;
            color: white;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .response-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            height: 600px;
            overflow-y:  auto;
            font-family:  'Courier New', monospace;
        }

        .response-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius:  8px;
            border-left: 4px solid #666;
        }

        .response-item.sent {
            border-left-color: #3b82f6;
            background: #1e3a5f;
        }

        .response-item.received {
            border-left-color: #10b981;
            background: #1e3a2f;
        }

        .response-item.error {
            border-left-color: #ef4444;
            background: #3a1e1e;
        }

        .response-item.info {
            border-left-color: #f59e0b;
            background: #3a2e1e;
        }

        .response-header {
            display:  flex;
            justify-content:  space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .response-type {
            text-transform: uppercase;
            font-size: 12px;
        }

        .response-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .response-content {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 13px;
        }

        .clear-btn {
            float: right;
            padding: 5px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .navigation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .verification-status {
            padding: 15px;
            border-radius: 8px;
            margin:  10px 0;
            font-weight: bold;
            text-align: center;
        }

        .verification-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .verification-status.verified {
            background: #d4edda;
            color: #155724;
        }

        .verification-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .template-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .template-btn {
            padding: 8px;
            background: #e9ecef;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .template-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”Œ WebSocket Tester</h1>
            <p>Test deposit, withdrawal, and custom messages</p>
        </div>

        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Connection -->
                <div class="connection-section">
                    <div class="section-title">
                        <span class="status-indicator" id="statusIndicator"></span>
                        Connection
                    </div>
                    
                    <div class="form-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="wsUrl" value="wss://api.safarigari.com/api/v1/cashier/svc/ws">
                    </div>

                    <div class="form-group">
                        <label>Bearer Token</label>
                        <input type="password" id="bearerToken" value="eyJhbGciOiJSUzI1NiIsImtpZCI6ImtpZC12MSIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiIzNzU1Njk0MjE5NjEyOTc5MjAiLCJkZXZpY2UiOiIzNTUyMDM2ODQ5MjMwODQ4MDAiLCJpc190ZW1wIjpmYWxzZSwidHlwZSI6InVzZXIiLCJwdXJwb3NlIjoiZ2VuZXJhbCIsInJvbGUiOiJreWNfdW52ZXJpZmllZCIsImlzcyI6ImF1dGgtc2VydmljZSIsInN1YiI6IjM3NTU2OTQyMTk2MTI5NzkyMCIsImF1ZCI6WyJweHl6LWNsaWVudHMiXSwiZXhwIjoxNzY5MTc3MjM5LCJuYmYiOjE3NjkxNTkyMzksImlhdCI6MTc2OTE1OTIzOSwianRpIjoiMDFLRk4xUTlLWkVWWkgyNDkzMDNLNTNZR0UifQ.P8SjVQ1HEIhFygkLWdodPPz-kVXQyTRoR4hkZPs_gO4Cp0dhiW0N8VEb6h6X32h2VqdyLp4CGZ70uUleQ1TvaJs-hq00tBL7DwFFcxiZLSbeto1Q40HJum6T6fdkkwMSF8UrMuTA296uGlDDi5QxPxF9xFasvXMuenuTVK4YW3sHkehKA6vVjPizyMMUpdPts3sQiGB7RJrMSVPqKWHp93K8rLzHDIu6z91lwiQLVqjaH_ld1J8zb21kXr8pAOIOiZzXN-be5IqQF-26IK5fgJTCTGLlaW-hjU8b0orvXNe9K4kjvysgukzIAib1nEWbbooqx8CLLox4kPP9xndhy0kJPhzi6QpUeXrdNvxddTJ9z3OBO-yP0u7-RdQjVYuhVwI7FpR7FVqq_zMnWJoEsKXjfeczbTACr4yenjCWORUV65igL0soHJ6DbxogzQpGf53GXPfumkyOyoDrheGl0G7A3OxNTPwCj54L-_KLEs-NsqoycMQakysYlQBYzoErC7N4qlwk3QF_zg-5AZR07d668gZQI1KH7pSgw_XX7wvjUSErtFXwW-Ep-NGJv9IQa6bKMFJwNRtkUvcIlAT9Hi-LanYmpQvMboMs8SDFZQMubIXbi5uKNm6b8z43VaCxaAeiO_A4rfy6c7OxSrX_oFgK-NE7xSSYNMzvGuViWQg">
                    </div>

                    <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">Connect</button>
                </div>

                <!-- Mode Selection -->
                <div class="workflow">
                    <div class="section-title">ðŸ“‹ Select Mode</div>
                    <button class="btn btn-secondary" onclick="startDepositFlow()">ðŸ’° Deposit Flow</button>
                    <button class="btn btn-secondary" onclick="startWithdrawalFlow()">ðŸ’¸ Withdrawal Flow</button>
                    <button class="btn btn-info" onclick="startCustomMode()">âš¡ Custom Message</button>
                </div>

                <!-- Current Workflow Steps -->
                <div class="workflow" id="workflowSteps" style="display: none;">
                    <div class="section-title">Current Flow</div>
                    <div id="stepsContainer"></div>
                    
                    <div class="navigation-buttons">
                        <button class="btn btn-warning" id="prevBtn" onclick="previousStep()" disabled>â—€ Previous</button>
                        <button class="btn btn-warning" id="nextBtn" onclick="nextStep()" disabled>Next â–¶</button>
                    </div>
                </div>

                <!-- Custom Mode Templates -->
                <div class="workflow" id="customTemplates" style="display: none;">
                    <div class="section-title">ðŸ“¦ Quick Templates</div>
                    <div class="template-selector">
                        <button class="template-btn" onclick="loadTemplate('get_balance')">Get Balance</button>
                        <button class="template-btn" onclick="loadTemplate('list_deposits')">List Deposits</button>
                        <button class="template-btn" onclick="loadTemplate('list_withdrawals')">List Withdrawals</button>
                        <button class="template-btn" onclick="loadTemplate('get_profile')">Get Profile</button>
                        <button class="template-btn" onclick="loadTemplate('calculate_fee')">Calculate Fee</button>
                        <button class="template-btn" onclick="loadTemplate('ping')">Ping</button>
                        <button class="template-btn" onclick="loadTemplate('custom')">Empty</button>
                    </div>
                </div>

                <!-- Message Form -->
                <div class="connection-section">
                    <div class="section-title">Message</div>
                    
                    <div class="form-group">
                        <label>Message Type</label>
                        <input type="text" id="messageType" placeholder="e.g., deposit_request, get_balance">
                    </div>

                    <div class="form-group">
                        <label>Message Data (JSON)</label>
                        <textarea id="messageData" placeholder='{"key": "value"}'></textarea>
                    </div>

                    <button class="btn btn-success" id="sendBtn" onclick="sendMessage()" disabled>Send Message</button>

                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="formatJSON()">Format JSON</button>
                        <button class="btn btn-secondary" onclick="clearInput()">Clear Input</button>
                    </div>
                </div>

                <!-- Verification Status -->
                <div id="verificationStatus" class="verification-status" style="display: none;"></div>
            </div>

            <!-- Right Panel:  Responses -->
            <div class="right-panel">
                <div class="section-title">
                    ðŸ“¨ Responses
                    <button class="clear-btn" onclick="clearResponses()">Clear All</button>
                </div>
                <div class="response-container" id="responseContainer">
                    <div class="response-item info">
                        <div class="response-header">
                            <span class="response-type">Info</span>
                            <span class="response-time">Ready</span>
                        </div>
                        <div class="response-content">WebSocket tester ready. Connect and select a mode to begin.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let currentFlow = null;
        let currentStep = 0;
        let verificationToken = null;
        let lastDepositRef = null;
        let isCustomMode = false;

        // Workflow definitions
        const workflows = {
            deposit: {
                name: 'Deposit Flow',
                steps: [
                    { name: 'Initiate Deposit', type: 'deposit_request', template: 'deposit' },
                    { name: 'Check Deposit Status', type: 'get_deposit_status', template: 'check_deposit' }
                ]
            },
            withdrawal: {
                name: 'Withdrawal Flow (with Verification)',
                steps: [
                    { name: 'Request Verification (OTP Email)', type: 'verification_request', template: 'verification' },
                    { name:  'Verify OTP Code', type: 'verify_otp', template: 'verify_otp' },
                    { name: 'Initiate Withdrawal', type: 'withdraw_request', template: 'withdraw' }
                ]
            }
        };

        // Message templates
        const templates = {
            verification: {
                method: 'otp_email',
                purpose: 'withdrawal'
            },
            verify_otp: {
                code: '123456',
                purpose: 'withdrawal'
            },
            deposit: {
                amount: 10,
                service:  'mpesa'
            },
            check_deposit: {
                request_ref: 'DEP-XXX-XXXXX'
            },
            withdraw: {
                amount: 10,
                destination: '254700536326',
                service: 'mpesa',
                verification_token: 'your_token_here',
                consent: true
            },
            // Custom templates
            get_balance: {
                currency: 'USD'
            },
            list_deposits: {
                limit: 10,
                offset: 0
            },
            list_withdrawals:  {
                limit: 10,
                offset: 0
            },
            calculate_fee: {
                amount: 10,
                source_currency: 'USD',
                transaction_type: 'withdrawal'
            },
            get_profile: {},
            ping: {
                timestamp: Date.now()
            },
            custom: {}
        };

        // Start custom mode
        function startCustomMode() {
            if (! isConnected) {
                alert('Please connect to WebSocket first');
                return;
            }
            
            isCustomMode = true;
            currentFlow = null;
            
            // Hide workflow steps
            document.getElementById('workflowSteps').style.display = 'none';
            
            // Show custom templates
            document.getElementById('customTemplates').style.display = 'block';
            
            // Enable message type input
            document.getElementById('messageType').removeAttribute('readonly');
            document.getElementById('messageType').value = '';
            document.getElementById('messageData').value = '';
            
            showVerificationStatus('pending', 'âš¡ Custom Mode Active - Use templates or type your own message');
        }

        // Load template
        function loadTemplate(templateName) {
            const messageTypeInput = document.getElementById('messageType');
            const messageDataInput = document.getElementById('messageData');
            
            messageTypeInput.value = templateName;
            
            if (templates[templateName]) {
                messageDataInput.value = JSON.stringify(templates[templateName], null, 2);
            }
            
            showVerificationStatus('verified', `âœ… Template loaded: ${templateName}`);
        }

        // Start deposit flow
        function startDepositFlow() {
            if (!isConnected) {
                alert('Please connect to WebSocket first');
                return;
            }
            isCustomMode = false;
            currentFlow = 'deposit';
            currentStep = 0;
            lastDepositRef = null;
            
            document.getElementById('customTemplates').style.display = 'none';
            document.getElementById('messageType').setAttribute('readonly', true);
            
            renderWorkflow();
            loadStepTemplate();
            updateNavigationButtons();
        }

        // Start withdrawal flow
        function startWithdrawalFlow() {
            if (!isConnected) {
                alert('Please connect to WebSocket first');
                return;
            }
            isCustomMode = false;
            currentFlow = 'withdrawal';
            currentStep = 0;
            verificationToken = null;
            
            document.getElementById('customTemplates').style.display = 'none';
            document.getElementById('messageType').setAttribute('readonly', true);
            
            renderWorkflow();
            loadStepTemplate();
            updateNavigationButtons();
        }

        // Render workflow steps
        function renderWorkflow() {
            const workflow = workflows[currentFlow];
            if (!workflow) return;

            document.getElementById('workflowSteps').style.display = 'block';
            const container = document.getElementById('stepsContainer');
            container.innerHTML = '';

            workflow.steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                if (index < currentStep) stepDiv.classList.add('completed');
                if (index === currentStep) stepDiv.classList.add('active');

                stepDiv.onclick = () => goToStep(index);

                stepDiv.innerHTML = `
                    <span class="step-number">${index + 1}</span>
                    <strong>${step.name}</strong>
                    <div style="font-size: 12px;color:#666;margin-left:40px;">${step.type}</div>
                `;
                container.appendChild(stepDiv);
            });
        }

        // Load current step template
        function loadStepTemplate() {
            const workflow = workflows[currentFlow];
            if (!workflow) return;

            const step = workflow.steps[currentStep];
            if (!step) return;

            document.getElementById('messageType').value = step.type;
            const templateData = JSON.parse(JSON.stringify(templates[step.template]));
            
            // Auto-fill values from previous steps
            if (step.type === 'get_deposit_status' && lastDepositRef) {
                templateData.request_ref = lastDepositRef;
            }
            if (step.type === 'withdraw_request' && verificationToken) {
                templateData.verification_token = verificationToken;
            }

            document.getElementById('messageData').value = JSON.stringify(templateData, null, 2);
            document.getElementById('sendBtn').disabled = false;
        }

        // Go to specific step
        function goToStep(stepIndex) {
            const workflow = workflows[currentFlow];
            if (!workflow || stepIndex < 0 || stepIndex >= workflow.steps.length) return;

            currentStep = stepIndex;
            renderWorkflow();
            loadStepTemplate();
            updateNavigationButtons();
        }

        // Move to next step
        function nextStep() {
            const workflow = workflows[currentFlow];
            if (!workflow) return;

            if (currentStep >= workflow.steps.length - 1) {
                showVerificationStatus('verified', `âœ… ${workflow.name} completed!`);
                setTimeout(() => {
                    currentFlow = null;
                    currentStep = 0;
                    document.getElementById('workflowSteps').style.display = 'none';
                }, 2000);
                return;
            }

            currentStep++;
            renderWorkflow();
            loadStepTemplate();
            updateNavigationButtons();
        }

        // Move to previous step
        function previousStep() {
            if (currentStep <= 0) return;

            currentStep--;
            renderWorkflow();
            loadStepTemplate();
            updateNavigationButtons();
        }

        // Update navigation button states
        function updateNavigationButtons() {
            const workflow = workflows[currentFlow];
            if (!workflow) return;

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentStep === 0;
            nextBtn.disabled = currentStep >= workflow.steps.length - 1;
        }

        // Connect/Disconnect
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        function connect() {
            var url = document.getElementById('wsUrl').value;
            const token = document.getElementById('bearerToken').value;

            if (token) {
                const separator = url.includes('?') ? '&' : '?';
                url = url + separator + 'token=' + encodeURIComponent(token);
            }

            if (! url) {
                addResponse('error', 'WebSocket URL is required', {});
                return;
            }

            try {
                addResponse('info', 'Connecting to ' + url, {});
                ws = new WebSocket(url);

                ws.onopen = () => {
                    isConnected = true;
                    updateConnectionUI();
                    addResponse('received', 'Connected to WebSocket server', {
                        url: url,
                        timestamp: new Date().toISOString()
                    });
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        addResponse('received', 'Message received', data);
                        if (! isCustomMode) {
                            handleServerResponse(data);
                        }
                    } catch (e) {
                        addResponse('received', 'Message received (non-JSON)', { raw: event.data });
                    }
                };

                ws.onerror = (error) => {
                    addResponse('error', 'WebSocket error', { error: error.message || 'Connection error' });
                };

                ws.onclose = () => {
                    isConnected = false;
                    updateConnectionUI();
                    addResponse('info', 'Disconnected from server', {});
                };

            } catch (error) {
                addResponse('error', 'Connection failed', { error: error.message });
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            isConnected = false;
            updateConnectionUI();
        }

        // Send message
        function sendMessage() {
            if (!isConnected) {
                addResponse('error', 'Not connected to WebSocket', {});
                return;
            }

            const type = document.getElementById('messageType').value;
            const dataStr = document.getElementById('messageData').value;

            if (!type) {
                addResponse('error', 'Please enter a message type', {});
                return;
            }

            try {
                const data = dataStr ? JSON.parse(dataStr) : {};
                const message = {
                    type: type,
                    data: data
                };

                ws.send(JSON.stringify(message));
                addResponse('sent', 'Message sent:  ' + type, message);
            } catch (error) {
                addResponse('error', 'Invalid JSON in message data', { error: error.message });
            }
        }

        // Handle server response with auto-navigation
        function handleServerResponse(response) {
            if (!currentFlow) return;

            const workflow = workflows[currentFlow];
            const step = workflow.steps[currentStep];

            // Handle verification request
            if (step.type === 'verification_request' && response.type === 'success') {
                showVerificationStatus('pending', 'ðŸ“§ OTP sent!  Check your email and enter the code.');
                setTimeout(() => nextStep(), 1500);
            }

            // Handle OTP verification
            if (step.type === 'verify_otp' && response.type === 'success') {
                if (response.data && response.data.verification_token) {
                    verificationToken = response.data.verification_token;
                    showVerificationStatus('verified', 'âœ… Verification successful!  Token received.');
                    setTimeout(() => nextStep(), 1500);
                }
            }

            // Handle deposit initiation
            if (step.type === 'deposit_request' && response.type === 'success') {
                if (response.data && response.data.request_ref) {
                    lastDepositRef = response.data.request_ref;
                    showVerificationStatus('verified', `âœ… Deposit initiated:  ${response.data.request_ref}`);
                    setTimeout(() => nextStep(), 1500);
                }
            }

            // Handle deposit status check
            if (step.type === 'get_deposit_status' && response.type === 'success') {
                showVerificationStatus('verified', 'âœ… Deposit status retrieved successfully! ');
            }

            // Handle withdrawal initiation
            if (step.type === 'withdraw_request' && response.type === 'success') {
                showVerificationStatus('verified', 'âœ… Withdrawal initiated successfully!');
                setTimeout(() => {
                    currentFlow = null;
                    document.getElementById('workflowSteps').style.display = 'none';
                }, 2000);
            }

            // Handle errors
            if (response.type === 'error') {
                showVerificationStatus('failed', `âŒ Error: ${response.message || 'Unknown error'}`);
            }
        }

        // Show verification status
        function showVerificationStatus(status, message) {
            const statusDiv = document.getElementById('verificationStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = `verification-status ${status}`;
            statusDiv.textContent = message;

            if (status === 'verified' || status === 'failed') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Format JSON
        function formatJSON() {
            const textarea = document.getElementById('messageData');
            try {
                const obj = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(obj, null, 2);
            } catch (e) {
                addResponse('error', 'Invalid JSON - cannot format', {});
            }
        }

        // Clear input
        function clearInput() {
            document.getElementById('messageData').value = '';
        }

        // Clear responses
        function clearResponses() {
            document.getElementById('responseContainer').innerHTML = '';
        }

        // Add response to UI
        function addResponse(type, message, data) {
            const container = document.getElementById('responseContainer');
            const item = document.createElement('div');
            item.className = `response-item ${type}`;

            const time = new Date().toLocaleTimeString();
            const dataStr = Object.keys(data).length > 0 ? JSON.stringify(data, null, 2) : '';

            item.innerHTML = `
                <div class="response-header">
                    <span class="response-type">${type}</span>
                    <span class="response-time">${time}</span>
                </div>
                <div class="response-content">${message}${dataStr ?  '\n\n' + dataStr : ''}</div>
            `;

            container.appendChild(item);
            container.scrollTop = container.scrollHeight;
        }

        // Update connection UI
        function updateConnectionUI() {
            const indicator = document.getElementById('statusIndicator');
            const connectBtn = document.getElementById('connectBtn');

            if (isConnected) {
                indicator.classList.add('connected');
                connectBtn.textContent = 'Disconnect';
                connectBtn.classList.add('btn-danger');
                connectBtn.classList.remove('btn-primary');
                document.getElementById('sendBtn').disabled = false;
            } else {
                indicator.classList.remove('connected');
                connectBtn.textContent = 'Connect';
                connectBtn.classList.add('btn-primary');
                connectBtn.classList.remove('btn-danger');
                document.getElementById('sendBtn').disabled = true;
            }
        }
    </script>
</body>
</html>