version: '3.9'

services:
  # üîπ Traefik - the single entrypoint
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"   # ‚ö†Ô∏è remove in production
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"

      # üß© Enable detailed logs
      - "--log.level=DEBUG"

      # üßæ Enable access logs (shows every incoming request)
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.filepath=/var/log/traefik/access.log"
    ports:
      - "70:80"      # Map host:70 to container:80
      - "7070:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - micro_net

  # üîπ Redis
  redis:
    image: redis:7
    container_name: redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - micro_net

    # No port exposure needed - only accessed by other containers

  # üîπ Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks:
      - micro_net

  # üîπ Kafka
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    ports:
      - "9093:9093"  # External access from host if needed
    networks:
      - micro_net
    depends_on:
      - zookeeper
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server=localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 10
  prometheus:
    image: prom/prometheus:latest
    container_name: receipt-prometheus
    ports:
      - "9091:9090"  # External:Internal (avoid conflict with receipt-service:9090)
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro  # ‚úÖ Read-only
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'  #  ADDED: Allow config reload
    networks:
      - micro_net  #  ADDED: Must be on same network as receipt-service
    restart: unless-stopped  #  ADDED: Auto-restart
    healthcheck:  #  ADDED: Health check
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana (for visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: receipt-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: false
      GF_INSTALL_PLUGINS: grafana-piechart-panel  #  ADDED: Useful plugins
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro  #  ADDED: Auto-load dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro  #  ADDED: Auto-configure datasource
    networks:
      - micro_net  #  ADDED: Must be on same network
    restart: unless-stopped  #  ADDED: Auto-restart
    depends_on:
      - prometheus

  # üîπ Audit Service
  audit-service:
    build:
      context: .
      dockerfile: services/common-services/authentication/audit-service/Dockerfile
    container_name: audit-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-audit.rule=PathPrefix(`/api/v1/audit`)"
      - "traefik.http.services.user-audit.loadbalancer.server.port=8008"
    env_file:
      - ./services/common-services/authentication/audit-service/.env
    volumes:
      - ./services/common-services/authentication/audit-service/secrets:/app/secrets:ro
    networks:
      - micro_net
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_user
      HTTP_ADDR: :8008
      GRPC_ADDR: :8007
      REDIS_ADDR: redis:6379
      REDIS_PASS:

      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
      JWT_AUDIENCE: pxyz-clients
      JWT_ISSUER: audit-service
      JWT_ACCESS_TTL: 24h

    extra_hosts:
      - "212.95.35.81:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_started

  # üîπ Auth Service
  auth-service:
    build:
      context: .
      dockerfile: services/common-services/authentication/auth-service/Dockerfile
    container_name: auth-service
    labels:
      - "traefik.enable=true"
      # --- Main Auth API ---
      - "traefik.http.routers.auth.rule=PathPrefix(`/api/v1/auth`) || PathPrefix(`/api/v1/oauth2`)"
      - "traefik.http.routers.auth.entrypoints=web"
      - "traefik.http.services.auth.loadbalancer.server.port=8001"

      # --- OAuth2 Service ---
      # - "traefik.http.routers.oauth2.rule=PathPrefix(`/api/v1/oauth2`)"
      # - "traefik.http.routers.oauth2.entrypoints=web"
      # - "traefik.http.services.oauth2.loadbalancer.server.port=8001"
    env_file:
      - ./services/common-services/authentication/auth-service/.env
    volumes:
      - ./services/common-services/authentication/auth-service/secrets:/app/secrets:ro
      - ./services/common-services/authentication/auth-service/ui:/app/ui
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_user
      KAFKA_BROKERS: kafka:9092
      REDIS_ADDR: redis:6379
      SYSTEM_ADMIN_PASSWORD: 96211581#Aa
      SYSTEM_ADMIN_EMAIL: anthonyalando8@gmail.com
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_started
      traefik:
        condition: service_started
      core-service:
        condition: service_started
      session-service:
        condition: service_started
      email-service:
        condition: service_started
      sms-service:
        condition: service_started
      otp-service:
        condition: service_started
      notification-service:
        condition: service_started
      u-access-service:
        condition: service_started

  # üîπ Session Service
  session-service:
    build:
      context: .
      dockerfile: services/common-services/authentication/session-mngt/Dockerfile
    container_name: session-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.session.rule=PathPrefix(`/api/v1/session`)"
      - "traefik.http.routers.session.entrypoints=web"
      - "traefik.http.services.session.loadbalancer.server.port=8002"
    env_file:
      - ./services/common-services/authentication/session-mngt/.env
    volumes:
      - ./services/common-services/authentication/session-mngt/secrets:/app/secrets:ro
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_user
      REDIS_ADDR: redis:6379
      KAFKA_BROKERS: kafka:9092
      JWT_PRIVATE_KEY_PATH: /app/secrets/jwt_private.pem
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis
      - u-access-service

  # üîπ SMS Service
  sms-service:
    build:
      context: .
      dockerfile: services/common-services/comms-services/sms-service/Dockerfile
    container_name: sms-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sms.rule=PathPrefix(`/api/v1/sms`)"
      - "traefik.http.routers.sms.entrypoints=web"
      - "traefik.http.services.sms.loadbalancer.server.port=8012"
    env_file:
      - ./services/common-services/comms-services/sms-service/.env
    volumes:
      - ./services/common-services/comms-services/sms-service/secrets:/app/secrets:ro
    environment:
      GRPC_ADDR: :8012
      REDIS_PASS:
      KAFKA_BROKERS: kafka:9092
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
      WA_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJieXVmU1hvSnFHY2NPcWNXOW82NXRWMWI4WVdsMEd3aSIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzU2NzQ3MjMzfQ.npCbVvXb2i_gAkBr3iXi_spHVbBG4l_ZXgqevm8jfjg
      WA_URL: https://www.whatsupsender.co.ke
      WA_SENDER: 254792207010
      SMS_URL: https://smsportal.hostpinnacle.co.ke/SMSApi/send
      SMS_KEY:
      SENDER: DERINANCE
      USER_ID: samderinance
      PASSWORD: Fbq75Ttz
      REDIS_ADDR: redis:6379
    networks:
      - micro_net
    depends_on:
      - redis
      - email-service

  # üîπ Email Service
  email-service:
    build:
      context: .
      dockerfile: services/common-services/comms-services/email-service/Dockerfile
    container_name: email-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.email.rule=PathPrefix(`/api/v1/email`)"
      - "traefik.http.routers.email.entrypoints=web"
      - "traefik.http.services.email.loadbalancer.server.port=8011"
    env_file:
      - ./services/common-services/comms-services/email-service/.env
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_user
      KAFKA_BROKERS: kafka:9092
      REDIS_ADDR: redis:6379
      GRPCPort: :8011
      SMTPHost: mail.derinance.com
      SMTPUser: no_reply@derinance.com
      SMTPPort: 465
      SMTPPass: B-e02G#D-T7O*8Qe
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis

  # üîπ OTP Service
  otp-service:
    build:
      context: .
      dockerfile: services/common-services/authentication/otp-service/Dockerfile
    container_name: otp-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.otp.rule=PathPrefix(`/api/v1/otp`)"
      - "traefik.http.routers.otp.entrypoints=web"
      - "traefik.http.services.otp.loadbalancer.server.port=8003"
    env_file:
      - ./services/common-services/authentication/otp-service/.env
    environment:
      DB_CONN: postgres://sam:Kenya_2025!@212.95.35.81:5432/pxyz_user
      REDIS_ADDR: redis:6379
      KAFKA_BROKERS: kafka:9092
      EMAIL_SVC_ADDR: email-service:8011
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis
      - email-service

  # üîπ Core Service
  core-service:
    build:
      context: .
      dockerfile: services/common-services/core-service/Dockerfile
    container_name: core-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.core.rule=PathPrefix(`/api/v1/core`)"
      - "traefik.http.routers.core.entrypoints=web"
      - "traefik.http.services.core.loadbalancer.server.port=8051"
    env_file:
      - ./services/common-services/core-service/.env
    volumes:
      - ./services/common-services/core-service/secrets:/app/secrets:ro
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_user
      REDIS_ADDR: redis:6379
      KAFKA_BROKERS: kafka:9092
      HTTP_ADDR: :8051
      GRPC_ADDR: :8052
      REDIS_PASS:
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis

  # üîπ Notification Service
  notification-service:
    build:
      context: .
      dockerfile: services/common-services/comms-services/notification-service/Dockerfile
    container_name: notification-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.notification.rule=PathPrefix(`/api/v1/user/notifications`)"
      - "traefik.http.routers.notification.entrypoints=web"
      - "traefik.http.services.notification.loadbalancer.server.port=8013"
    env_file:
      - ./services/common-services/comms-services/notification-service/.env
    volumes:
      - ./services/common-services/comms-services/notification-service/secrets:/app/secrets:ro
      - ./services/common-services/comms-services/notification-service/templates:/app/templates:ro
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_user
      KAFKA_BROKERS: kafka:9092
      REDIS_ADDR: redis:6379
      HTTP_ADDR: :8013
      GRPC_ADDR: :8014
      REDIS_PASS:
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis

  # üîπ User Access Service
  u-access-service:
    build:
      context: .
      dockerfile: services/common-services/authentication/u-access-service/Dockerfile
    container_name: u-access-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uaccess.rule=PathPrefix(`/api/v1/urbac`)"
      - "traefik.http.routers.uaccess.entrypoints=web"
      - "traefik.http.services.uaccess.loadbalancer.server.port=8031"
    env_file:
      - ./services/common-services/authentication/u-access-service/.env
    volumes:
      - ./services/common-services/authentication/u-access-service/secrets:/app/secrets:ro
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_user
      KAFKA_BROKERS: kafka:9092
      REDIS_ADDR: redis:6379
      HTTP_ADDR: :8031
      GRPC_ADDR: :8032
      REDIS_PASS:
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis

  # üîπ Account Service
  account-service:
    build:
      context: .
      dockerfile: services/user-services/account-service/Dockerfile
    container_name: account-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-account.rule=PathPrefix(`/api/v1/account`)"
      - "traefik.http.services.user-account.loadbalancer.server.port=8004"
    env_file:
      - ./services/user-services/account-service/.env
    networks:
      - micro_net
    extra_hosts:
    - "212.95.35.81:host-gateway"
    environment:
      DB_CONN: postgres://sam:Kenya_2025!@212.95.35.81:5432/pxyz_user
      REDIS_ADDR: redis:6379
      EMAIL_SVC_ADDR: email-service:8011
      GRPC_ADDR: :8004
      REDIS_PASS:
    depends_on:
      - redis
      - email-service
  # üîπ KYC Service
  kyc-service:
    build:
      context: .
      dockerfile: services/user-services/kyc-service/Dockerfile
    container_name: kyc-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kyc.rule=PathPrefix(`/api/v1/kyc`)"
      - "traefik.http.services.kyc.loadbalancer.server.port=8005"
    env_file:
      - ./services/user-services/kyc-service/.env
    volumes:
      - ./services/user-services/kyc-service/secrets:/app/secrets:ro
      - ./uploads:/app/uploads
    networks:
      - micro_net
    extra_hosts:
      - "212.95.35.81:host-gateway"
    environment:
      HTTP_ADDR: :8005
      DB_CONN: postgres://sam:Kenya_2025!@212.95.35.81:5432/pxyz_user
      REDIS_ADDR: redis:6379
      REDIS_PASS:
      EMAIL_SVC_ADDR: email-service:8011
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    depends_on:
      - redis
      - email-service

  admin-auth-service:
    build:
      context: .
      dockerfile: services/admin-services/admin-auth-service/Dockerfile
    container_name: admin-auth-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-auth.rule=PathPrefix(`/api/v1/admin/auth`)"
      - "traefik.http.services.admin-auth.loadbalancer.server.port=7000"

      # üî∏ Strip the `/api/v1` prefix
      - "traefik.http.middlewares.admin-auth-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.admin-auth.middlewares=ptnaccess-stripprefix"
    env_file:
      - ./services/admin-services/admin-auth-service/.env
    volumes:
      - ./services/admin-services/admin-auth-service/secrets:/app/secrets:ro
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_admin
      REDIS_ADDR: redis:6379
      SYSTEM_ADMIN_PASSWORD: 96211581#Aa
      SYSTEM_ADMIN_EMAIL: anthonyalando8@gmail.com
    networks:
      - micro_net
    depends_on:
      - redis
      - core-service
      - admin-session-service
      - email-service
      - otp-service

  # üîπ Session Service
  admin-session-service:
    build:
      context: .
      dockerfile: services/admin-services/admin-session-mngt/Dockerfile
    container_name: admin-session-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-session.rule=PathPrefix(`/api/v1/admin/session`)"
      - "traefik.http.services.admin-session.loadbalancer.server.port=7003"

      # üî∏ Strip the `/api/v1` prefix
      - "traefik.http.middlewares.admin-session-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.admin-session.middlewares=ptnaccess-stripprefix"
    env_file:
      - ./services/admin-services/admin-session-mngt/.env
    volumes:
      - ./services/admin-services/admin-session-mngt/secrets:/app/secrets:ro
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_admin
      REDIS_ADDR: redis:6379
      JWT_PRIVATE_KEY_PATH: /app/secrets/jwt_private.pem
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    networks:
      - micro_net
    depends_on:
      - redis

  admin-service:
    build:
      context: .
      dockerfile: services/admin-services/admin-service/Dockerfile
    container_name: admin-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-svc.rule=PathPrefix(`/api/v1/admin/svc`)"
      - "traefik.http.services.admin-svc.loadbalancer.server.port=7010"

      # üî∏ Strip the `/api/v1` prefix
      - "traefik.http.middlewares.admin-svc-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.admin-svc.middlewares=ptnaccess-stripprefix"
    env_file:
      - ./services/admin-services/admin-service/.env
    volumes:
      - ./services/admin-services/admin-service/secrets:/app/secrets:ro
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_admin
      REDIS_ADDR: redis:6379
    networks:
      - micro_net
    depends_on:
      - redis
      - core-service
      - admin-session-service
      - email-service
  # üîπ Ptn Access Service
  admin-access-service:
    build:
      context: .
      dockerfile: services/admin-services/u-access-service/Dockerfile
    container_name: admin-access-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adminaccess.rule=PathPrefix(`/api/v1/admin/urbac`)"
      - "traefik.http.routers.adminaccess.entrypoints=web"
      - "traefik.http.services.adminaccess.loadbalancer.server.port=7004"

      # üî∏ Strip the `/api/v1` prefix
      - "traefik.http.middlewares.adminaccess-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.adminaccess.middlewares=ptnaccess-stripprefix"
    env_file:
      - ./services/admin-services/u-access-service/.env
    volumes:
      - ./services/admin-services/u-access-service/secrets:/app/secrets:ro
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_admin
      KAFKA_BROKERS: kafka:9092
      REDIS_ADDR: redis:6379
      HTTP_ADDR: :7004
      GRPC_ADDR: :7005
      REDIS_PASS:
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis

  # üîπ Partner Service
  partner-service:
    build:
      context: .
      dockerfile: services/partner-services/partner-service/Dockerfile
    container_name: partner-service
    
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      
      # Router configuration
      - "traefik.http.routers.partner-svc.rule=PathPrefix(`/api/v1/partner/svc`) || PathPrefix(`/api/v1/partner/api`)"
      - "traefik.http.routers.partner-svc.entrypoints=web"  # ‚úÖ Explicit entrypoint
      
      # Service configuration
      - "traefik.http.services.partner-svc.loadbalancer.server.port=7510"
      
      # Middleware configuration
      - "traefik.http.middlewares.partner-svc-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.partner-svc.middlewares=partner-svc-stripprefix"
    
    env_file:
      - ./services/partner-services/partner-service/.env
    
    volumes:
      - ./services/partner-services/partner-service/secrets:/app/secrets:ro
    
    networks:
      - micro_net
    
    extra_hosts:
      - "212.95.35.81:host-gateway"
    
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_partner
      HTTP_ADDR: :7510
      GRPC_ADDR: :7511
      REDIS_ADDR: redis:6379
      REDIS_PASS: ""
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    
    depends_on:
      redis:
        condition: service_healthy  # ‚úÖ Wait for Redis
    
    restart: unless-stopped  # ‚úÖ Auto-restart on failure
    

  # üîπ Ptn Session Service
  ptn-session-service:
    build:
      context: .
      dockerfile: services/partner-services/ptn-session-mngt/Dockerfile
    container_name: ptn-session-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.partner-session.rule=PathPrefix(`/api/v1/partner/session`)"
      - "traefik.http.services.partner-session.loadbalancer.server.port=7503"

      # üî∏ Strip the `/api/v1` prefix
      - "traefik.http.middlewares.partner-session-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.partner-session.middlewares=ptnaccess-stripprefix"
    env_file:
      - ./services/partner-services/ptn-session-mngt/.env
    volumes:
      - ./services/partner-services/ptn-session-mngt/secrets:/app/secrets:ro
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_partner
      REDIS_ADDR: redis:6379
      JWT_PRIVATE_KEY_PATH: /app/secrets/jwt_private.pem
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    networks:
      - micro_net
    depends_on:
      - redis

  # üîπ Ptn Access Service
  ptn-access-service:
    build:
      context: .
      dockerfile: services/partner-services/u-access-service/Dockerfile
    container_name: ptn-access-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ptnaccess.rule=PathPrefix(`/api/v1/partner/urbac`)"
      - "traefik.http.routers.ptnaccess.entrypoints=web"
      - "traefik.http.services.ptnaccess.loadbalancer.server.port=7504"

      # üî∏ Strip the `/api/v1` prefix
      - "traefik.http.middlewares.ptnaccess-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.ptnaccess.middlewares=ptnaccess-stripprefix"
    env_file:
      - ./services/partner-services/u-access-service/.env
    volumes:
      - ./services/partner-services/u-access-service/secrets:/app/secrets:ro
      - ./uploads:/app/uploads
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_partner
      KAFKA_BROKERS: kafka:9092
      REDIS_ADDR: redis:6379
      HTTP_ADDR: :7504
      GRPC_ADDR: :7505
      REDIS_PASS:
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
    extra_hosts:
      - "212.95.35.81:host-gateway"
    networks:
      - micro_net
    depends_on:
      - redis
  receipt-service:
    build:
      context: .
      dockerfile: services/common-services/fx-services/receipt-service/Dockerfile
    container_name: receipt-service
    ports:
      - "8026:8026"  # gRPC port
      - "9090:9090"  # Metrics port (Prometheus)
    
    #  OPTION 2: If you need Traefik for gRPC (uncomment below)
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.tcp.routers.receipt-grpc.rule=HostSNI(`*`)"
    #   - "traefik.tcp.routers.receipt-grpc.entrypoints=grpc"
    #   - "traefik.tcp.services.receipt-grpc.loadbalancer.server.port=8026"
    
    env_file:
      - ./services/common-services/fx-services/receipt-service/.env
    
    volumes:
      - ./uploads:/app/uploads
    
    environment:
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_fx
      
      DB_MAX_CONNS: 100              # Critical for high throughput
      DB_MIN_CONNS: 20               # Keep warm connections
      DB_MAX_CONN_LIFETIME: 30m      # Recycle connections
      DB_MAX_CONN_IDLE_TIME: 5m      # Close idle connections
      
      REDIS_ADDR: redis:6379
      REDIS_PASS: ""
      REDIS_DB: 0
      
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC: receipt
      
      GRPC_ADDR: :8026               # gRPC server port
      METRICS_PORT: 9090             # ADDED - Prometheus metrics
      
      MACHINE_ID: 19                  # Each instance should have unique ID
      
      LOG_LEVEL: info                # debug, info, warn, error
      
    networks:
      - micro_net
    
    extra_hosts:
      - "212.95.35.81:host-gateway"
    
    # ADDED: Health check
    healthcheck:
      test: ["CMD", "grpcurl", "-plaintext", "localhost:8026", "receipt.ReceiptService/HealthCheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # ADDED: Proper dependencies
    depends_on:
      redis:
        condition: service_healthy   # Wait for Redis to be healthy
      kafka:
        condition: service_healthy   # Wait for Kafka to be healthy

    # ADDED: Resource limits (optional but recommended)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    
    # ADDED: Restart policy
    restart: unless-stopped

  accounting-service:
      build:
        context: .
        dockerfile: services/common-services/fx-services/accounting-service/Dockerfile
      container_name: accounting-service
      ports:
      - "8024:8024"  # gRPC port
      # labels:
      #   - "traefik.enable=true"
      #   - "traefik.http.routers.accounting.rule=PathPrefix(`/accounting`)"
      #   - "traefik.http.services.accounting.loadbalancer.server.port=8024"
      env_file:
        - ./services/common-services/fx-services/accounting-service/.env
      volumes:
        - ./services/common-services/fx-services/accounting-service/secrets:/app/secrets:ro
        - ./uploads:/app/uploads
      networks:
        - micro_net
      environment:
        DB_HOST: 212.95.35.81
        DB_PORT: 5432
        DB_USER: sam
        DB_PASSWORD: Kenya_2025!
        DB_NAME: pxyz_fx
        REDIS_ADDR: redis:6379
        GRPC_ADDR: :8024
        REDIS_PASS:
        JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
      depends_on:
        redis:
          condition: service_healthy   # Wait for Redis to be healthy
        kafka:
          condition: service_healthy
      extra_hosts:
      - "212.95.35.81:host-gateway"
  # üîπ Cashier Service
  cashier-service:
    build:
      context: .
      dockerfile: services/user-services/cashier-service/Dockerfile
    container_name: cashier-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cashier.rule=PathPrefix(`/api/v1/cashier/`)"
      - "traefik.http.services.cashier.loadbalancer.server.port=8021"

      - "traefik.http.middlewares.cashier-stripprefix.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.cashier.middlewares=ptnaccess-stripprefix"
    env_file:
      - ./services/user-services/cashier-service/.env
    volumes:
      - ./services/user-services/cashier-service/secrets:/app/secrets:ro
    networks:
      - micro_net
    environment:
      HTTP_ADDR: :8021
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025!
      DB_NAME: pxyz_fx
      REDIS_ADDR: redis:6379
      REDIS_PASS:
      JWT_PRIVATE_KEY_PATH: /app/secrets/jwt_private.pem
      JWT_PUBLIC_KEY_PATH: /app/secrets/jwt_public.pem
      JWT_AUDIENCE: pxyz-clients
      JWT_ISSUER: auth-service
      JWT_ACCESS_TTL: 5h
      MPESA_CONSUMER_KEY: WE0ODHDhooeTBWhIxIwbqM3L7cd9SSxTagXCrZhynGmwRiAp
      MPESA_CONSUMER_SECRET: fDLAvAoRFT6QBnKgrxNrUfA3Mozx0btGpm7DIGqVBfn44adGiDHtdKlJnJ9jbN1K
      MPESA_PASSKEY: bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919
      MPESA_SHORT_CODE: 174379
      MPESA_TILL_NUMBER: 174379
    depends_on:
        redis:
          condition: service_healthy   # Wait for Redis to be healthy
    extra_hosts:
      - "212.95.35.81:host-gateway"  
  payment-service:
    build:
      context: .
      dockerfile: services/common-services/fx-services/payment-service/Dockerfile
    container_name: payment-service

    volumes:
      - ./services/common-services/fx-services/payment-service/certs:/app/certs:ro
    
    labels:
      - "traefik.enable=true"
      
      # HTTP routes for webhooks and callbacks
      - "traefik.http.routers.payment.rule=PathPrefix(`/api/v1/payments`) || PathPrefix(`/api/v1/webhooks`) || PathPrefix(`/api/v1/callbacks`)"
      - "traefik.http.routers.payment.entrypoints=web"
      - "traefik.http.services.payment.loadbalancer.server.port=8027"
      
      # Strip prefix middleware (optional)
      # - "traefik.http.middlewares.payment-stripprefix.stripprefix.prefixes=/api/v1"
      # - "traefik.http.routers.payment.middlewares=payment-stripprefix"
    
    env_file:
      - ./services/common-services/fx-services/payment-service/.env
    
    ports:
      - "8027:8027"  # HTTP port (for webhooks/callbacks)
    
    environment:
      # Server
      SERVER_PORT: 8027
      ENVIRONMENT: production
      
      # Database
      DB_HOST: 212.95.35.81
      DB_PORT: 5432
      DB_USER: sam
      DB_PASSWORD: Kenya_2025! 
      DB_NAME: pxyz_fx
      DB_SSL_MODE: disable
      
      # M-Pesa Configuration
      MPESA_ENVIRONMENT: production
      MPESA_CERT_PATH: /app/certs/cert.cer
      MPESA_CONSUMER_KEY: ${MPESA_CONSUMER_KEY:-wEA6YGhwryMXXTKtd1D56GB4JAs3x8crdrO2Od1oBjd1lrrJ}
      MPESA_CONSUMER_SECRET: ${MPESA_CONSUMER_SECRET:-DWravQBWqsX1H4BADy5aIS4tVx2cQSsfCRPsVjA3q5od5IKKKptjkk1WGpdGDZ5B}
      MPESA_PASSKEY: ${MPESA_PASSKEY:-88d5db37f317ec4187458429c2ad4082ceb0691becbfd19589da695d2866058a}
      MPESA_SHORT_CODE: ${MPESA_SHORT_CODE:-4001513}
      MPESA_INITIATOR_NAME: ${MPESA_INITIATOR_NAME:-testapi}
      MPESA_SECURITY_CREDENTIAL: ${MPESA_SECURITY_CREDENTIAL:-your_security_credential}

      B2C_SHORT_CODE: ${B2C_SHORT_CODE:-4001513}
      B2C_INITIATOR_NAME: ${B2C_INITIATOR_NAME:-SAMWEB}
      B2C_PASSWORD: ${B2C_PASSWORD:-Samson@200010!}
      B2C_SECURITY_CREDENTIAL: ${B2C_SECURITY_CREDENTIAL:-your_b2c_security_credential}
      B2C_PASSKEY:  ${B2C_PASSKEY:-88d5db37f317ec4187458429c2ad4082ceb0691becbfd19589da695d2866058a}
      B2C_CONSUMER_KEY: ${B2C_CONSUMER_KEY:-wEA6YGhwryMXXTKtd1D56GB4JAs3x8crdrO2Od1oBjd1lrrJ}
      B2C_CONSUMER_SECRET: ${B2C_CONSUMER_SECRET:-DWravQBWqsX1H4BADy5aIS4tVx2cQSsfCRPsVjA3q5od5IKKKptjkk1WGpdGDZ5B}
      
      # Partner Configuration
      PARTNER_API_KEY: ${PARTNER_API_KEY:-pk_P-cFwhoDeQZPmERPPCp-ssCQcNm1JAkUI7-kjnOChd8=}
      PARTNER_API_SECRET: ${PARTNER_API_SECRET:-sk__SvW-useAWtD29zZbN1R0q6s4efACf2IR5AT3gU3hmnlVTJNxPJne7Na2kDjoxDh}
      PARTNER_WEBHOOK_URL: https://api.safarigari.com
      CALLBACK_BASE_URL: https://api.safarigari.com
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD:  ""
      REDIS_DB: 0
    
    networks:
      - micro_net
    
    extra_hosts:
      - "212.95.35.81:host-gateway"
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8027/api/v1/payments/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    
    # Dependencies
    depends_on:
      redis:
        condition: service_healthy
      # kafka:
      #   condition: service_healthy
      accounting-service:
        condition: service_started  # Payment service calls accounting for credit
      partner-service:
        condition: service_started  # Payment service calls partner service
    
    # Resource limits
    deploy:
      resources: 
        limits:
          cpus:  '1.0'
          memory: 1G
        reservations: 
          cpus: '0.5'
          memory: 512M
    
    # Restart policy
    restart: unless-stopped
    
    # Logging
    logging: 
      driver: "json-file"
      options: 
        max-size: "10m"
        max-file: "3"

volumes:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  micro_net:
    driver: bridge